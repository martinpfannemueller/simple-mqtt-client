"use strict";function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}var mqtt=require("mqtt"),manuh=require("manuh"),ManuhBridge=require("manuh-bridge").ManuhBridge,debug=require("debug")("mqtt-provider-debug");module.exports.new=function(){return new function(){this.init=function(o,e,i,n,r){var s=this;if(!o)throw console.error("mqttBrokerHost not FOUND!"),"mqttBrokerHost parameter is not set. Please provide a MQTT broker host to connect";var u=this;if(0!=this.bootstrapStatus)return r(u);this.bootstrapStatus=1;var a=void 0;e&&(a={username:e,password:i}),debug("Connecting to MQTT with: \nMQTT_BROKER_HOST="+o,"\nMQTT_USERNAME="+e,"\nMQTT_PASSWORD="+i,"\nMQTT_BASE_TOPIC="+n),this.baseTopic=n,debug("baseTopic:",this.baseTopic);var c=o.split("://"),h="mqtt",p=null,b=c[1],d="";if(-1!=c[0].indexOf("https")?h="wss":-1!=c[0].indexOf("http")&&(h="ws"),-1!=c[1].indexOf(":")){var l=c[1].split(":");b=l[0],p=-1!=l[1].indexOf("/")?l[1].split("/")[0]:l[1]}if(-1!=c[1].indexOf("/")&&c[1].indexOf("/")!=c[1].length-1){var m=c[1].split("/");b=-1!=m[0].indexOf(":")?m[0].split(":")[0]:m[0],d=m[1]}var f={protocol:h,host:b,port:p,context:d},g="".concat(f.protocol,"://").concat(f.host).concat(f.port?":"+f.port:"","/").concat(f.context);debug("mqttConnectionConfig=",f),this.manuhBridge=new ManuhBridge(manuh,f,function(){debug("ManuhBridge connections completed."),debug("Connecting directly to MQTT. brokerURL:",g),s.mqttClient=mqtt.connect(g,a),s.mqttClient.on("connect",function(o){o?u.bootstrapStatus<2?(u.bootstrapStatus=2,debug("connection succeed. Details:",o),r(u)):debug("connected again. Details:",o):console.error(t("Error connecting to interaction bus"))})})},this.publish=function(t,o){if(!this.isReady())throw"mqttProvider not yet initiated. Call `init` method with correspondent parameters";var e;if(e=this.baseTopic?this.baseTopic+"/"+t:t,"object"!==_typeof(o))throw"Could not publish non-objects to the chat mqtt provider";this.mqttClient.publish(e,JSON.stringify(o))},this.subscribe=function(t,e){var o,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:"mqtt-provider";if(!this.isReady())throw"mqttProvider not yet initiated. Call `init` method with correspondent parameters";o=this.baseTopic?this.baseTopic+"/"+t:t,this.manuhBridge.subscribeRemote2LocalTopics([o]),manuh.unsubscribe(o,i),manuh.subscribe(o,i,function(t,o){"string"==typeof t&&(t=JSON.parse(t)),e(t)})},this.unsubscribe=function(t){var o=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"mqtt-provider",e=this.baseTopic+"/"+t;manuh.unsubscribe(e,o)},this.isReady=function(){return 2==this.bootstrapStatus},this.baseTopic=null,this.mqttClient=null,this.manuhBridge=null,this.bootstrapStatus=0}};