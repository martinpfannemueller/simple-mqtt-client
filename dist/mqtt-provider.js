"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},mqtt=require("mqtt"),manuh=require("manuh"),ManuhBridge=require("./manuh-bridge/manuh-bridge").ManuhBridge,debug=require("debug")("debug");module.exports={init:function(e,i,o,n,r){var s=this;if(!e)throw console.error("mqttBrokerHost not FOUND!"),"mqttBrokerHost parameter is not set. Please provide a MQTT broker host to connect";var a=this;if(0!=this.bootstrapStatus)return r(a);this.bootstrapStatus=1;var u=void 0;i&&(u={username:i,password:o}),debug("Connecting to MQTT with: \nMQTT_BROKER_HOST="+e,"\nMQTT_USERNAME="+i,"\nMQTT_PASSWORD="+o,"\nMQTT_BASE_TOPIC="+n),this.baseTopic=n||"chimpassist/demo",debug("baseTopic:",this.baseTopic);var c=e.split("://"),p="mqtt",h=null,d=c[1],b="";if(-1!=c[0].indexOf("https")?p="https":-1!=c[0].indexOf("http")&&(p="http"),-1!=c[1].indexOf(":")){var m=c[1].split(":");d=m[0],h=-1!=m[1].indexOf("/")?m[1].split("/")[0]:m[1]}if(-1!=c[1].indexOf("/")){var l=c[1].split("/");d=-1!=l[0].indexOf(":")?l[0].split(":")[0]:l[0],b=l[1]}var f={protocol:p,host:d,port:h,context:b};debug("manuhMQTTBridgeConfig=",f),this.manuhBridge=new ManuhBridge(manuh,f,function(){s.manuhBridge.subscribeRemote2LocalTopics([s.baseTopic+"/#"]),s.mqttClient=mqtt.connect(e,u),s.mqttClient.on("connect",function(e){e?a.bootstrapStatus<2?(a.bootstrapStatus=2,debug("connection succeed. Details:",e),r(a)):debug("connected again. Details:",e):console.error(t("Error connecting to interaction bus"))})})},publish:function(t,e){if(!this.isReady())throw"mqttProvider not yet initiated. Call `init` method with correspondent parameters";var i=this.baseTopic+"/"+t;if("object"!==(void 0===e?"undefined":_typeof(e)))throw"Could not publish non-objects to the chat mqtt provider";this.mqttClient.publish(i,JSON.stringify(e))},subscribe:function(t,i){var e=2<arguments.length&&void 0!==arguments[2]?arguments[2]:"mqtt-provider";if(!this.isReady())throw"mqttProvider not yet initiated. Call `init` method with correspondent parameters";var o=this.baseTopic+"/"+t;manuh.subscribe(o,e,function(t,e){"string"==typeof t&&(t=JSON.parse(t)),i(t)})},unsubscribe:function(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"mqtt-provider",i=this.baseTopic+"/"+t;manuh.unsubscribe(i,e)},isReady:function(){return 2==this.bootstrapStatus},baseTopic:null,mqttClient:null,manuhBridge:null,bootstrapStatus:0};