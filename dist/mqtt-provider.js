"use strict";function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}var mqtt=require("mqtt"),manuh=require("manuh"),ManuhBridge=require("manuh-bridge").ManuhBridge,debug=require("debug")("mqtt-provider-debug");module.exports={init:function(o,e,i,n,r){var s=this;if(!o)throw console.error("mqttBrokerHost not FOUND!"),"mqttBrokerHost parameter is not set. Please provide a MQTT broker host to connect";var a=this;if(0!=this.bootstrapStatus)return r(a);this.bootstrapStatus=1;var c=void 0;e&&(c={username:e,password:i}),debug("Connecting to MQTT with: \nMQTT_BROKER_HOST="+o,"\nMQTT_USERNAME="+e,"\nMQTT_PASSWORD="+i,"\nMQTT_BASE_TOPIC="+n),this.baseTopic=n||"chimpassist/demo",debug("baseTopic:",this.baseTopic);var u=o.split("://"),p="mqtt",d=null,h=u[1],b="";if(-1!=u[0].indexOf("https")?p="wss":-1!=u[0].indexOf("http")&&(p="ws"),-1!=u[1].indexOf(":")){var l=u[1].split(":");h=l[0],d=-1!=l[1].indexOf("/")?l[1].split("/")[0]:l[1]}if(-1!=u[1].indexOf("/")&&u[1].indexOf("/")!=u[1].length-1){var m=u[1].split("/");h=-1!=m[0].indexOf(":")?m[0].split(":")[0]:m[0],b=m[1]}var f={protocol:p,host:h,port:d,context:b},g="".concat(f.protocol,"://").concat(f.host).concat(f.port?":"+f.port:"","/").concat(f.context);debug("mqttConnectionConfig=",f),this.manuhBridge=new ManuhBridge(manuh,f,function(){debug("ManuhBridge connections completed."),debug("Connecting directly to MQTT. brokerURL:",g),s.mqttClient=mqtt.connect(g,c),s.mqttClient.on("connect",function(o){o?a.bootstrapStatus<2?(a.bootstrapStatus=2,debug("connection succeed. Details:",o),r(a)):debug("connected again. Details:",o):console.error(t("Error connecting to interaction bus"))})})},publish:function(t,o){if(!this.isReady())throw"mqttProvider not yet initiated. Call `init` method with correspondent parameters";var e=this.baseTopic+"/"+t;if("object"!==_typeof(o))throw"Could not publish non-objects to the chat mqtt provider";this.mqttClient.publish(e,JSON.stringify(o))},subscribe:function(t,e){var o=2<arguments.length&&void 0!==arguments[2]?arguments[2]:"mqtt-provider";if(!this.isReady())throw"mqttProvider not yet initiated. Call `init` method with correspondent parameters";var i=this.baseTopic+"/"+t;this.manuhBridge.subscribeRemote2LocalTopics([i]),manuh.subscribe(i,o,function(t,o){"string"==typeof t&&(t=JSON.parse(t)),e(t)})},unsubscribe:function(t){var o=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"mqtt-provider",e=this.baseTopic+"/"+t;manuh.unsubscribe(e,o)},isReady:function(){return 2==this.bootstrapStatus},baseTopic:null,mqttClient:null,manuhBridge:null,bootstrapStatus:0};